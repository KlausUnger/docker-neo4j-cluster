machine:
  services:
      - docker
dependencies:
  cache_directories:
      - "~/docker"
  override:
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - docker build -t wayblazer/docker-neo4j-cluster .
    - mkdir -p ~/docker; docker save wayblazer/docker-neo4j-cluster > ~/docker/image.tar

#TODO: Until we can curl the host, not worth the build time to do this.
test:
  override:
    - echo "Skip Tests"
deployment:
  branches:
    branch: /[0-9]+(\.[0-9]+)(\.[0-9]+)/
    commands:
      - docker login -e $DOCKERHUB_EMAIL -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWORD
      - docker tag wayblazer/docker-neo4j-cluster wayblazer/docker-neo4j-cluster:$CIRCLE_TAG
      - docker push wayblazer/docker-neo4j-cluster:$CIRCLE_TAG
  latest:
    branch: master
    commands:
      - docker login -e $DOCKERHUB_EMAIL -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWORD
      - docker push wayblazer/docker-neo4j-cluster
